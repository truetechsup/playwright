name: Playwright Tests

on:
  repository_dispatch:
    types: [run-tests]

jobs:
  get-data-from-webhook:
    runs-on: ubuntu-latest
    outputs:
      adapter_mode: ${{ steps.set-vars.outputs.ADAPTER_MODE }}
      tms_url: ${{ steps.set-vars.outputs.TMS_URL }}
      test_run_id: ${{ steps.set-vars.outputs.TEST_RUN_ID }}
      project_id: ${{ steps.set-vars.outputs.PROJECT_ID }}
      configuration_ids: ${{ steps.set-vars.outputs.CONFIGURATION_IDS }}
    
    steps:
    - name: Get data from webhook
      id: set-vars
      run: |
        echo "ADAPTER_MODE=${{ github.event.client_payload.adapter_mode }}" >> $GITHUB_OUTPUT
        echo "TMS_URL=${{ github.event.client_payload.url }}" >> $GITHUB_OUTPUT
        echo "TEST_RUN_ID=${{ github.event.client_payload.test_run_id }}" >> $GITHUB_OUTPUT
        echo "PROJECT_ID=${{ github.event.client_payload.project_id }}" >> $GITHUB_OUTPUT
        echo "CONFIGURATION_IDS=${{ github.event.client_payload.configuration_id[0] }}" >> $GITHUB_OUTPUT

  setup-filter:
    runs-on: ubuntu-latest
    needs: get-data-from-webhook
    if: needs.get-data-from-webhook.outputs.adapter_mode == '1'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install testit-cli
      run: |
        python -m pip install --upgrade pip
        pip install testit-cli==2.8.1
    
    - name: Setup TestIT filter
      run: |
        export TMS_TOKEN=${{ secrets.TMS_PRIVATE_TOKEN }}
        mkdir -p tmp
        
        testit autotests_filter \
          --url "${{ needs.get-data-from-webhook.outputs.tms_url }}" \
          --configuration-id "${{ needs.get-data-from-webhook.outputs.configuration_ids }}" \
          --testrun-id "${{ needs.get-data-from-webhook.outputs.test_run_id }}" \
          --framework playwright \
          --disable-cert-validation \
          --output tmp/filter.txt
        
        if [ ! -s tmp/filter.txt ]; then
          echo "empty" > tmp/filter.txt
        fi
    
    - name: Upload filter artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-filter
        path: tmp/filter.txt
        retention-days: 1

  run-tests:
    runs-on: ubuntu-latest
    needs: [get-data-from-webhook, setup-filter]
    if: always() && (needs.setup-filter.result == 'success' || needs.setup-filter.result == 'skipped')
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download filter artifact
      if: needs.get-data-from-webhook.outputs.adapter_mode == '1'
      uses: actions/download-artifact@v4
      with:
        name: test-filter
        path: tmp/
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        npm install
        npx playwright install --with-deps
    
    - name: Run Playwright tests (adapterMode=1)
      if: needs.get-data-from-webhook.outputs.adapter_mode == '1'
      env:
        TMS_TOKEN: ${{ secrets.TMS_PRIVATE_TOKEN }}
        TMS_URL: ${{ needs.get-data-from-webhook.outputs.tms_url }}
        TMS_TEST_RUN_ID: ${{ needs.get-data-from-webhook.outputs.test_run_id }}
        TMS_PROJECT_ID: ${{ needs.get-data-from-webhook.outputs.project_id }}
        TMS_CONFIGURATION_ID: ${{ needs.get-data-from-webhook.outputs.configuration_ids }}
        TMS_ADAPTER_MODE: ${{ needs.get-data-from-webhook.outputs.adapter_mode }}
      run: |
        FILTER=$(cat tmp/filter.txt)
        if [ -z "$FILTER" ] || [ "$FILTER" = "empty" ]; then
          echo "No tests to run"
          exit 0
        fi
        npx playwright test --grep "$FILTER"
    
    - name: Run Playwright tests (adapterMode=2)
      if: needs.get-data-from-webhook.outputs.adapter_mode == '2'
      env:
        TMS_TOKEN: ${{ secrets.TMS_PRIVATE_TOKEN }}
        TMS_URL: ${{ needs.get-data-from-webhook.outputs.tms_url }}
        TMS_PROJECT_ID: ${{ needs.get-data-from-webhook.outputs.project_id }}
        TMS_CONFIGURATION_ID: ${{ needs.get-data-from-webhook.outputs.configuration_ids }}
        TMS_ADAPTER_MODE: ${{ needs.get-data-from-webhook.outputs.adapter_mode }}
      run: |
        npx playwright test
    
    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30