name: Playwright Tests

on:
  repository_dispatch:
    types: [run-tests]

jobs:

  setup-filter:
    runs-on: ubuntu-latest
    outputs:
      test_run_id: ${{ steps.set-vars.outputs.TEST_RUN_ID }}
      project_id: ${{ steps.set-vars.outputs.PROJECT_ID }}
      configuration_ids: ${{ steps.set-vars.outputs.CONFIGURATION_IDS }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install testit-cli
        run: |
          python -m pip install --upgrade pip
          pip install testit-cli==2.7.3

      - name: Get data from webhook
        id: set-vars
        run: |
          echo "TEST_RUN_ID=${{ github.event.client_payload.test_run_id }}" >> $GITHUB_OUTPUT
          echo "PROJECT_ID=${{ github.event.client_payload.project_id }}" >> $GITHUB_OUTPUT
          echo "CONFIGURATION_IDS=${{ github.event.client_payload.configuration_id[0] }}" >> $GITHUB_OUTPUT


      - name: Setup TestIT filter
        run: |
          export TMS_TOKEN=${{ secrets.TMS_PRIVATE_TOKEN }}
          mkdir -p tmp

          echo "Generating test filter with parameters:"
          echo "URL: ${{ secrets.TMS_URL }}"
          echo "Configuration ID: ${{ github.event.client_payload.configuration_id[0] }}"
          echo "Test Run ID: ${{ github.event.client_payload.test_run_id }}"

          testit autotests_filter \
            --url "${{ secrets.TMS_URL }}" \
            --configuration-id "${{ github.event.client_payload.configuration_id[0] }}" \
            --testrun-id "${{ github.event.client_payload.test_run_id }}" \
            --framework golang \
            --disable-cert-validation \
            --output tmp/filter.txt

          echo "Filter file created:"
          cat tmp/filter.txt

          # Проверяем, что файл не пустой
          if [ ! -s tmp/filter.txt ]; then
            echo "WARNING: Filter file is empty!"
            echo "empty" > tmp/filter.txt
          fi

      - name: Upload filter artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-filter
          path: tmp/filter.txt
          retention-days: 1

  test:
    runs-on: ubuntu-latest
    needs: setup-filter

    steps:
      - uses: actions/checkout@v3

      - name: Download filter artifact
        uses: actions/download-artifact@v4
        with:
          name: test-filter
          path: tmp/

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Playwright and TestIT adapter
        run: |
          # Инициализируем package.json если его нет
          if [ ! -f package.json ]; then
            npm init -y
          fi
          
          # Устанавливаем Playwright
          npm install @playwright/test
          
          # Устанавливаем адаптер TestIT для Playwright
          npm install testit-adapter-playwright@3.4.7
          
          # Устанавливаем браузеры
          npx playwright install --with-deps

      - name: Run Playwright tests
        env:
          TMS_TOKEN: ${{ secrets.TMS_PRIVATE_TOKEN }}
          TMS_TEST_RUN_ID: ${{ needs.setup-filter.outputs.test_run_id }}
          TMS_PROJECT_ID: ${{ needs.setup-filter.outputs.project_id }}
          TMS_CONFIGURATION_ID: ${{ needs.setup-filter.outputs.configuration_ids }}
        run: |
          echo "Test parameters:"
          echo "Test Run ID: $TMS_TEST_RUN_ID"
          echo "Project ID: $TMS_PROJECT_ID"
          echo "Configuration ID: $TMS_CONFIGURATION_ID"
          
          # Читаем фильтр из файла
          FILTER_FILE="tmp/filter.txt"
          if [ ! -f "$FILTER_FILE" ]; then
          echo "ERROR: Filter file not found at $FILTER_FILE"
          exit 1
          fi
          FILTER=$(cat "$FILTER_FILE")
          echo "Filter content: $FILTER"
          
          # Проверяем, есть ли тесты для запуска
          if [ -z "$FILTER" ] || [ "$FILTER" = "" ] || [ "$FILTER" = "empty" ]; then
          echo "No tests to run according to filter"
          exit 0
          fi
          echo "Test Run ID: $TMS_TEST_RUN_ID"
          npx playwright test --grep "$(cat tmp/filter.txt)"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30